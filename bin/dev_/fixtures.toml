# Fixtures - initial data set up automatically on dev environment startup
#
# Applied automatically by: ./bin/dev
# Run manually with: ./bin/dev fixtures
#
# Fixtures are applied in order. Each fixture type:
#   bucket  - Create a bucket
#   file    - Upload a file to a bucket
#   dir     - Create a directory in a bucket
#   share   - Share a bucket with a peer (role: owner/mirror)
#   publish - Publish a bucket (grant decryption to mirrors)
#   mv      - Move/rename a file or directory

# =============================================================================
# OWNER NODE: Create and set up test bucket
# =============================================================================

# Create a test bucket on owner node
[[fixture]]
type = "bucket"
name = "test"
node = "owner"

# Upload a file at root level
[[fixture]]
type = "file"
bucket = "test"
path = "/hello.txt"
content = "Hello from jax-bucket!\n"
node = "owner"

# Create a nested directory
[[fixture]]
type = "dir"
bucket = "test"
path = "/docs"
node = "owner"

# Upload a nested file
[[fixture]]
type = "file"
bucket = "test"
path = "/docs/readme.md"
content = """# Test Bucket

This is a test bucket for demonstrating jax-bucket features.

## Files
- `/hello.txt` - A simple greeting
- `/docs/readme.md` - This file

## Sharing
This bucket is shared with:
- `_owner` node as **owner** (can read/write)
- `mirror` node as **mirror** (can sync, decrypt after publish)
"""
node = "owner"

# Share with _owner node as owner
[[fixture]]
type = "share"
bucket = "test"
peer = "_owner"
role = "owner"
node = "owner"

# Share with mirror as mirror
[[fixture]]
type = "share"
bucket = "test"
peer = "mirror"
role = "mirror"
node = "owner"

# Publish the bucket (grant decryption to mirrors)
[[fixture]]
type = "publish"
bucket = "test"
node = "owner"

# =============================================================================
# OWNER NODE: Modify the bucket
# =============================================================================

# Move the original file to a nested directory
# Note: Running on owner node since sync from owner->_owner may not be complete yet
[[fixture]]
type = "mv"
bucket = "test"
from = "/hello.txt"
to = "/docs/hello.txt"
node = "owner"

# =============================================================================
# FUSE MOUNT TEST (optional - only runs if FUSE is available)
# =============================================================================

# Mount the bucket via FUSE on owner node
[[fixture]]
type = "mount"
bucket = "test"
mount_point = "/tmp/jax-e2e-mount"
node = "owner"

# Verify FUSE mount works (list, read, write, delete)
[[fixture]]
type = "mount_verify"
bucket = "test"
mount_point = "/tmp/jax-e2e-mount"
node = "owner"

# Unmount when done
[[fixture]]
type = "unmount"
bucket = "test"
node = "owner"

# =============================================================================
# EXPECTED END STATE
# =============================================================================
#
# After all fixtures apply successfully:
#
# Bucket "test" structure:
#   /docs/
#   /docs/hello.txt    (moved from /hello.txt)
#   /docs/readme.md
#
# Node visibility:
#   - owner  (API:5002, GW:8081): Owns bucket, sees latest state
#   - _owner (API:5003, GW:8082): Owner share, sees latest state after sync
#   - mirror (API:5004, GW:8083): Mirror share, sees latest published state
#
# FUSE mount test (if FUSE available):
#   - Mounts bucket at /tmp/jax-e2e-mount on owner node
#   - Verifies: directory listing, file read, file write, file delete
#   - Unmounts after verification
#
# Each node runs separate API and gateway servers:
#   - API:     http://localhost:5002 (owner), 5003 (_owner), 5004 (mirror)
#   - Gateway: http://localhost:8081 (owner), 8082 (_owner), 8083 (mirror)
#
# Verify with:
#   ./bin/dev api owner ls <bucket_id> /docs
#   ./bin/dev api _owner ls <bucket_id> /docs
#   curl http://localhost:8083/gw/<bucket_id>/docs/hello.txt
#
# FUSE verification (manual):
#   ./bin/dev api owner mount-list
#   ls /tmp/jax-e2e-mount/docs/
