name: Create Release PR

on:
  push:
    branches:
      - main
  workflow_dispatch: # Allow manual trigger

jobs:
  release-pr:
    name: Create/Update Release PR
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Need full history for smart-release
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: ~/.cargo/registry
          key: ${{ runner.os }}-cargo-registry-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-registry-

      - name: Cache cargo index
        uses: actions/cache@v4
        with:
          path: ~/.cargo/git
          key: ${{ runner.os }}-cargo-index-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-index-

      - name: Install cargo-smart-release
        run: cargo install cargo-smart-release

      - name: Configure git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Check if release is needed
        id: check
        run: |
          # Check if there are any conventional commits since the last release
          LATEST_TAG=$(git describe --tags --abbrev=0 --match "jax-bucket-v*" 2>/dev/null || echo "")

          if [ -z "$LATEST_TAG" ]; then
            echo "No previous release found, will create initial release"
            echo "needs_release=true" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Count commits with conventional commit prefixes since last tag
          COMMIT_COUNT=$(git log "$LATEST_TAG"..HEAD --oneline --grep="^feat\|^fix\|^feat!\|BREAKING CHANGE" | wc -l)

          if [ "$COMMIT_COUNT" -gt 0 ]; then
            echo "Found $COMMIT_COUNT conventional commits since $LATEST_TAG"
            echo "needs_release=true" >> $GITHUB_OUTPUT
          else
            echo "No conventional commits since $LATEST_TAG - skipping release PR"
            echo "needs_release=false" >> $GITHUB_OUTPUT
          fi

      - name: Create/update release branch
        if: steps.check.outputs.needs_release == 'true'
        run: |
          # Delete remote release-automation branch if it exists to start fresh
          git fetch origin
          if git ls-remote --heads origin release-automation | grep -q release-automation; then
            echo "Deleting existing release-automation branch on remote..."
            git push origin --delete release-automation || true
          fi

          # Create fresh release branch from main
          git checkout -b release-automation

      - name: Clean up orphaned tags
        if: steps.check.outputs.needs_release == 'true'
        run: |
          # Delete local tags that might conflict
          git tag -l "jax-*-v*" | xargs -r git tag -d || true

          # Check for orphaned tags (tags that exist but don't match any merged commit)
          # These are tags from failed previous workflow runs
          COMMON_VERSION=$(grep "^version" crates/common/Cargo.toml | cut -d'"' -f2)
          BUCKET_VERSION=$(grep "^version" crates/app/Cargo.toml | cut -d'"' -f2)

          # Calculate next patch versions (what smart-release will create)
          NEXT_COMMON=$(echo $COMMON_VERSION | awk -F. '{print $1"."$2"."$3+1}')
          NEXT_BUCKET=$(echo $BUCKET_VERSION | awk -F. '{print $1"."$2"."$3+1}')

          echo "Current versions: jax-common=$COMMON_VERSION, jax-bucket=$BUCKET_VERSION"
          echo "Expected next versions: jax-common=$NEXT_COMMON, jax-bucket=$NEXT_BUCKET"

          # Delete orphaned tags if they exist
          for tag in "jax-common-v$NEXT_COMMON" "jax-bucket-v$NEXT_BUCKET"; do
            if git ls-remote --tags origin | grep -q "refs/tags/$tag$"; then
              echo "Found orphaned tag $tag, deleting from remote..."
              git push origin --delete "$tag" || true
            fi
          done

      - name: Run cargo smart-release
        if: steps.check.outputs.needs_release == 'true'
        run: |
          # Execute release (updates files, creates tags, commits, and pushes)
          # Since we deleted the remote branch, the push will succeed
          cargo smart-release jax-bucket --execute --no-publish --allow-dirty --update-crates-index

      - name: Verify push succeeded
        if: steps.check.outputs.needs_release == 'true'
        run: |
          # Verify that smart-release successfully pushed everything
          echo "Checking that branch and tags were pushed..."

          # Check if branch exists on remote
          if git ls-remote --heads origin release-automation | grep -q release-automation; then
            echo "‚úÖ Branch release-automation pushed successfully"
          else
            echo "‚ùå Branch was not pushed, this is unexpected"
            exit 1
          fi

          # List tags that were created
          TAGS=$(git tag --points-at HEAD | grep -E "^jax-.*-v" || echo "")
          if [ -n "$TAGS" ]; then
            echo "‚úÖ Tags created: $TAGS"
          fi

      - name: Create or update PR
        if: steps.check.outputs.needs_release == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Check if PR already exists
          PR_NUM=$(gh pr list --head release-automation --base main --json number --jq '.[0].number')

          # Get version info for PR body
          VERSIONS=$(git tag --points-at HEAD | grep -E "^jax-.*-v" | sed 's/^/- /' || echo "- No new tags")

          PR_BODY="## Release Updates

          This PR contains automated version bumps and changelog updates based on conventional commits.

          ### New versions:
          $VERSIONS

          ### What to do:
          1. Review the version bumps in \`Cargo.toml\` files
          2. Review the \`CHANGELOG.md\` updates
          3. Merge this PR when ready to publish to crates.io

          **Note**: Merging this PR will push tags and trigger the publish workflow.

          ---
          ü§ñ Generated by [Release PR Workflow](.github/workflows/release-pr.yml)"

          if [ -z "$PR_NUM" ]; then
            # Create new PR
            gh pr create \
              --base main \
              --head release-automation \
              --title "chore: release updates" \
              --body "$PR_BODY"
            echo "Created new release PR"
          else
            # Update existing PR
            gh pr edit "$PR_NUM" --body "$PR_BODY"
            echo "Updated existing release PR #$PR_NUM"
          fi
