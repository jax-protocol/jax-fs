name: Create Release PR

on:
  push:
    branches:
      - main
  workflow_dispatch: # Allow manual trigger

jobs:
  release-pr:
    name: Create/Update Release PR
    runs-on: ubuntu-latest
    # CRITICAL: Skip if this is a release PR merge to prevent infinite loop
    if: "!contains(github.event.head_commit.message, 'Bump jax-')"
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Need full history for smart-release
          token: ${{ secrets.PAT_TOKEN || secrets.GITHUB_TOKEN }}

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: ~/.cargo/registry
          key: ${{ runner.os }}-cargo-registry-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-registry-

      - name: Cache cargo index
        uses: actions/cache@v4
        with:
          path: ~/.cargo/git
          key: ${{ runner.os }}-cargo-index-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-index-

      - name: Install cargo-smart-release
        run: cargo install cargo-smart-release

      - name: Configure git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Check if release is needed
        id: check
        run: |
          # Check if any crates are unpublished on crates.io using the API
          UNPUBLISHED=""
          for crate in jax-daemon jax-object-store jax-common; do
            HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" -H "User-Agent: jax-release-workflow" "https://crates.io/api/v1/crates/$crate")
            if [ "$HTTP_STATUS" = "404" ]; then
              echo "Crate $crate is not published on crates.io"
              UNPUBLISHED="$UNPUBLISHED $crate"
            else
              echo "Crate $crate exists on crates.io (HTTP $HTTP_STATUS)"
            fi
          done

          if [ -n "$UNPUBLISHED" ]; then
            echo "Unpublished crates found:$UNPUBLISHED"
            echo "needs_release=true" >> $GITHUB_OUTPUT
            echo "reason=unpublished_crates" >> $GITHUB_OUTPUT
            echo "unpublished=$UNPUBLISHED" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Get the latest release tag
          LATEST_TAG=$(git describe --tags --abbrev=0 --match "jax-daemon-v*" 2>/dev/null || echo "")

          if [ -z "$LATEST_TAG" ]; then
            echo "No previous release found, will create initial release"
            echo "needs_release=true" >> $GITHUB_OUTPUT
            echo "reason=no_previous_release" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "Latest release tag: $LATEST_TAG"

          # Check if there are conventional commits since the last tag
          COMMIT_COUNT=$(git log "$LATEST_TAG"..HEAD --oneline --grep="^feat\|^fix\|^feat!\|BREAKING CHANGE" | wc -l)

          if [ "$COMMIT_COUNT" -gt 0 ]; then
            echo "Found $COMMIT_COUNT conventional commits since $LATEST_TAG"
            echo "needs_release=true" >> $GITHUB_OUTPUT
            echo "reason=new_commits" >> $GITHUB_OUTPUT
          else
            echo "No conventional commits since $LATEST_TAG - skipping release PR"
            echo "needs_release=false" >> $GITHUB_OUTPUT
          fi

      - name: Create/update release branch
        if: steps.check.outputs.needs_release == 'true'
        run: |
          # Delete remote release-automation branch if it exists to start fresh
          git fetch origin
          if git ls-remote --heads origin release-automation | grep -q release-automation; then
            echo "Deleting existing release-automation branch on remote..."
            git push origin --delete release-automation || true
          fi

          # Create fresh release branch from main
          git checkout -b release-automation

      - name: Run cargo smart-release (for existing crates)
        id: smart-release
        if: steps.check.outputs.needs_release == 'true' && steps.check.outputs.reason != 'unpublished_crates'
        run: |
          # Execute release: updates files, creates commits, but NO TAGS
          # Tags will be created by publish workflow after PR is merged
          if cargo smart-release jax-daemon \
            --execute \
            --no-publish \
            --no-tag \
            --allow-dirty \
            --update-crates-index; then
            echo "has_changes=true" >> $GITHUB_OUTPUT
          else
            echo "smart-release found no crate changes to release"
            echo "has_changes=false" >> $GITHUB_OUTPUT
          fi

      - name: Create marker commit (for unpublished crates)
        id: unpublished
        if: steps.check.outputs.needs_release == 'true' && steps.check.outputs.reason == 'unpublished_crates'
        run: |
          # For unpublished crates, create a marker commit with timestamp
          # The publish workflow will handle the actual publish
          echo "Initial publish of new crates - $(date -u +%Y-%m-%dT%H:%M:%SZ)" > .initial-publish
          git add .initial-publish
          git commit -m "chore: initial publish of${{ steps.check.outputs.unpublished }}"
          echo "has_changes=true" >> $GITHUB_OUTPUT

      - name: Push release branch
        if: steps.check.outputs.needs_release == 'true' && (steps.smart-release.outputs.has_changes == 'true' || steps.unpublished.outputs.has_changes == 'true')
        run: |
          # Push branch (no tags to push)
          git push -u origin release-automation --force

      - name: Create or update PR
        if: steps.check.outputs.needs_release == 'true' && (steps.smart-release.outputs.has_changes == 'true' || steps.unpublished.outputs.has_changes == 'true')
        env:
          GH_TOKEN: ${{ secrets.PAT_TOKEN || secrets.GITHUB_TOKEN }}
        run: |
          # Check if PR already exists
          PR_NUM=$(gh pr list --head release-automation --base main --json number --jq '.[0].number')

          # Get version info from Cargo.toml
          COMMON_VERSION=$(grep "^version" crates/common/Cargo.toml | cut -d'"' -f2)
          DAEMON_VERSION=$(grep "^version" crates/daemon/Cargo.toml | cut -d'"' -f2)
          OBJECT_STORE_VERSION=$(grep "^version" crates/object-store/Cargo.toml | cut -d'"' -f2)
          DESKTOP_VERSION=$(grep "^version" crates/desktop/src-tauri/Cargo.toml | cut -d'"' -f2)

          PR_BODY="## Release Updates

          This PR contains automated version bumps and changelog updates based on conventional commits.

          ### New versions:
          - jax-common v$COMMON_VERSION
          - jax-object-store v$OBJECT_STORE_VERSION
          - jax-daemon v$DAEMON_VERSION
          - jax-desktop v$DESKTOP_VERSION

          ### What happens when merged:
          1. Tags will be created automatically
          2. Crates will be published to crates.io
          3. Desktop app binaries will be built and released to GitHub

          ### What to review:
          - Version bumps in \`Cargo.toml\` files
          - \`CHANGELOG.md\` updates
          - Ensure conventional commits are categorized correctly

          ---
          Generated by [Release PR Workflow](.github/workflows/release-pr.yml)"

          if [ -z "$PR_NUM" ]; then
            # Create new PR
            gh pr create \
              --base main \
              --head release-automation \
              --title "chore: release updates" \
              --body "$PR_BODY"
            echo "Created new release PR"
          else
            # Update existing PR
            gh pr edit "$PR_NUM" --body "$PR_BODY"
            echo "Updated existing release PR #$PR_NUM"
          fi
